<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RRPD Receiving Dashboard</title>

  <!-- FIX: repo file is style.css (NOT styles.css) -->
  <link rel="stylesheet" href="style.css" />

  <!-- CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <!-- FIX: repo file is detroit-axle-logo.png -->
      <img class="logo" src="detroit-axle-logo.png" alt="Detroit Axle" />
      <div>
        <div class="title">RRPD Receiving Dashboard</div>
        <div class="sub" id="csvStatus">No WH CSV loaded</div>
      </div>
    </div>

    <div class="actions">
      <label class="btn">
        Upload WH CSV
        <input id="whFile" type="file" accept=".csv" hidden />
      </label>

      <button class="btn" id="saveLogBtn" disabled>Save to Logs</button>
      <button class="btn primary" id="exportBtn" disabled>Export RRPD Summary</button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="dashboard">Dashboard</button>
    <button class="tab" data-tab="carriers">Carriers</button>
    <button class="tab" data-tab="returns">Returns Condition</button>
    <button class="tab" data-tab="manual">Manual Counts</button>
    <button class="tab" data-tab="manifest">Manifest</button>
    <button class="tab" data-tab="loose">Loose Parts</button>
    <button class="tab" data-tab="logs">Logs</button>
  </nav>

  <main class="container">

    <!-- DASHBOARD -->
    <section class="panel" id="tab-dashboard">
      <div class="panel-title">Tracking Counters (Total Scans)</div>
      <div class="panel-note">
        Tracking rows are ONLY <b>Return Label</b> / <b>Packing Slip</b>. Parts are ANY other classification.
        Box pieces use x2/x3… and also 2x/3x… (cap 50).
      </div>

      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-label">FedEx</div><div class="kpi-value" id="kpiFedex">0</div></div>
        <div class="kpi"><div class="kpi-label">UPS</div><div class="kpi-value" id="kpiUps">0</div></div>
        <div class="kpi"><div class="kpi-label">USPS</div><div class="kpi-value" id="kpiUsps">0</div></div>
        <div class="kpi"><div class="kpi-label">Other</div><div class="kpi-value" id="kpiOther">0</div></div>

        <div class="kpi wide"><div class="kpi-label">Total Scans</div><div class="kpi-value" id="kpiTotalScans">0</div></div>
        <div class="kpi"><div class="kpi-label">Unique Tracking Numbers</div><div class="kpi-value" id="kpiUniqueTracking">0</div></div>
        <div class="kpi"><div class="kpi-label">Total Parts (Pieces)</div><div class="kpi-value" id="kpiPartsPieces">0</div></div>
        <div class="kpi"><div class="kpi-label">Boxes With Multiple Parts</div><div class="kpi-value" id="kpiBoxesMulti">0</div></div>
        <div class="kpi wide"><div class="kpi-label">Repeated Tracking Numbers</div><div class="kpi-value" id="kpiRepeatedTracking">0</div></div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-title">Carrier Scans (Bar)</div>
          <canvas id="carrierChart" height="140"></canvas>
        </div>

        <div class="card">
          <div class="card-title">Tracking Samples (Latest 25)</div>
          <div class="small-note">On-screen verification only. Exports are counts-only.</div>
          <div class="list" id="trackingSamples"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Repeated Tracking Numbers (Top)</div>
        <div class="small-note">Tracking IDs that appear more than once (tracking rows only).</div>
        <table class="table" id="repeatsTable">
          <thead>
            <tr>
              <th>Tracking</th>
              <th class="num">Scans</th>
              <th>Carrier</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- CARRIERS -->
    <section class="panel hidden" id="tab-carriers">
      <div class="panel-title">Carriers</div>
      <div class="panel-note">Breakdown of tracking rows by carrier (Return Label / Packing Slip only).</div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title">Carrier Totals</div>
          <table class="table" id="carrierTotalsTable">
            <thead><tr><th>Carrier</th><th class="num">Tracking Rows</th><th class="num">Unique Tracking</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <div class="card-title">Carrier Samples</div>
          <div class="list" id="carrierSamples"></div>
        </div>
      </div>
    </section>

    <!-- RETURNS CONDITION -->
    <section class="panel hidden" id="tab-returns">
      <div class="panel-title">Returns Condition</div>
      <div class="panel-note">Counts by Return Condition (from the WH CSV condition column if present).</div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title">Return Conditions (Chart)</div>
          <canvas id="conditionChart" height="160"></canvas>
        </div>
        <div class="card">
          <div class="card-title">Condition Totals</div>
          <table class="table" id="conditionTable">
            <thead><tr><th>Condition</th><th class="num">Count</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MANUAL COUNTS -->
    <section class="panel hidden" id="tab-manual">
      <div class="panel-title">Manual Counts</div>
      <div class="panel-note">Enter manual counts that will be saved in Logs and included in exports.</div>

      <div class="manual-grid">
        <div class="manual-box">
          <div class="manual-title">Carriers</div>
          <div class="row">
            <label>Good : Core Racks</label>
            <input id="m_core_racks" type="number" min="0" value="0" />
          </div>
          <div class="row">
            <label>Good : Core Electric Racks</label>
            <input id="m_core_electric" type="number" min="0" value="0" />
          </div>
          <div class="row">
            <label>Good : Used Axles</label>
            <input id="m_used_axles" type="number" min="0" value="0" />
          </div>
          <div class="row">
            <label>Good : Used Drive Shafts</label>
            <input id="m_used_driveshafts" type="number" min="0" value="0" />
          </div>
          <div class="row">
            <label>Good : Used Gear boxes</label>
            <input id="m_used_gearboxes" type="number" min="0" value="0" />
          </div>
        </div>

        <div class="manual-box">
          <div class="manual-title">Loose Parts</div>
          <div class="row">
            <label>Loose Parts Count</label>
            <input id="m_loose_parts" type="number" min="0" value="0" />
          </div>
          <div class="row">
            <label>Notes</label>
            <input id="m_notes" type="text" placeholder="Optional notes..." />
          </div>
          <div class="row">
            <button class="btn" id="clearManualBtn" type="button">Clear Manual Inputs</button>
          </div>
        </div>
      </div>
    </section>

    <!-- MANIFEST -->
    <section class="panel hidden" id="tab-manifest">
      <div class="panel-title">Manifest</div>
      <div class="panel-note">
        Upload a manifest CSV. This panel extracts tracking numbers and compares them to scanned tracking rows.
      </div>

      <div class="manifest-actions">
        <label class="btn">
          Upload Manifest CSV
          <input id="manifestFile" type="file" accept=".csv" hidden />
        </label>
        <button class="btn" id="clearManifestBtn" type="button">Clear Manifest</button>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-title">Manifest Summary</div>
          <div class="kpi-grid compact">
            <div class="kpi"><div class="kpi-label">Manifest Tracking Found</div><div class="kpi-value" id="manifestFound">0</div></div>
            <div class="kpi"><div class="kpi-label">In Manifest NOT Scanned</div><div class="kpi-value" id="manifestMissing">0</div></div>
            <div class="kpi"><div class="kpi-label">Scanned NOT In Manifest</div><div class="kpi-value" id="scannedNotInManifest">0</div></div>
            <div class="kpi"><div class="kpi-label">FedEx In Manifest</div><div class="kpi-value" id="manifestFedex">0</div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Missing Lists (Top 50)</div>
          <div class="two-col">
            <div>
              <div class="mini-title">In Manifest, NOT Scanned</div>
              <div class="list" id="manifestMissingList"></div>
            </div>
            <div>
              <div class="mini-title">Scanned, NOT In Manifest</div>
              <div class="list" id="scannedNotInManifestList"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- LOOSE PARTS -->
    <section class="panel hidden" id="tab-loose">
      <div class="panel-title">Loose Parts</div>
      <div class="panel-note">This is a placeholder panel for future loose-part list/import if needed.</div>
      <div class="card">
        <div class="card-title">Loose Parts</div>
        <div class="small-note">Right now the export uses the manual Loose Parts count (Manual Counts tab).</div>
      </div>
    </section>

    <!-- LOGS -->
    <section class="panel hidden" id="tab-logs">
      <div class="panel-title">Logs</div>
      <div class="panel-note">
        Logs persist in this browser/device (localStorage). Use <b>Save to Logs</b> after each day.
      </div>

      <div class="log-actions">
        <button class="btn" id="exportLogsBtn" type="button">Export Logs CSV</button>
        <button class="btn danger" id="clearLogsBtn" type="button">Clear ALL Logs</button>
      </div>

      <table class="table" id="logsTable">
        <thead>
          <tr>
            <th>Date</th>
            <th class="num">Total Scans</th>
            <th class="num">FedEx</th>
            <th class="num">UPS</th>
            <th class="num">USPS</th>
            <th class="num">Other</th>
            <th class="num">Unique Tracking</th>
            <th class="num">Parts (Pieces)</th>
            <th class="num">Boxes Multi</th>
            <th class="num">Repeated IDs</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </main>

  <!-- EXPORT CONFIRM MODAL -->
  <div class="modal hidden" id="exportModal">
    <div class="modal-card">
      <div class="modal-title">RRPD Summary Preview</div>
      <div class="modal-body" id="exportPreview"></div>

      <label class="check">
        <input type="checkbox" id="confirmExportCheck" />
        I confirm this snapshot is correct.
      </label>

      <div class="modal-actions">
        <button class="btn" id="cancelExportBtn">Cancel</button>
        <button class="btn" id="exportPdfBtn" disabled>Export PDF</button>
        <button class="btn primary" id="exportExcelBtn" disabled>Export Excel</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
</body>
</html>
